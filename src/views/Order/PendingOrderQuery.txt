<template>
  <div class="pending-order-query">
    <div class="page-header">
      <h1>挂单记录查询</h1>
      <p>查询和管理挂单记录信息</p>
    </div>

    <!-- 筛选区域 -->
    <div class="filter-section">
      <el-card>
        <el-form
          ref="filterFormRef"
          :model="filterForm"
          inline
          class="filter-form"
        >
          <el-form-item label="姓名" prop="name">
            <el-input
              v-model="filterForm.name"
              placeholder="请输入姓名"
              clearable
              style="width: 200px"
            />
          </el-form-item>

          <el-form-item label="性别" prop="gender">
            <el-select
              v-model="filterForm.gender"
              placeholder="请选择性别"
              clearable
              style="width: 150px"
            >
              <el-option label="男" value="male" />
              <el-option label="女" value="female" />
            </el-select>
          </el-form-item>

          <el-form-item label="挂单次数" prop="orderCount">
            <el-input-number
              v-model="filterForm.orderCount"
              :min="0"
              placeholder="挂单次数"
              style="width: 150px"
            />
          </el-form-item>

          <el-form-item>
            <el-button type="primary" @click="handleSearch">
              <el-icon><Search /></el-icon>
              查询
            </el-button>
            <el-button @click="handleReset">
              <el-icon><Refresh /></el-icon>
              重置
            </el-button>
            <el-button
              type="success"
              :loading="exporting"
              @click="handleExport"
            >
              <el-icon><Download /></el-icon>
              导出
            </el-button>
          </el-form-item>
        </el-form>
      </el-card>
    </div>

    <!-- 数据表格 -->
    <div class="table-section">
      <el-card>
        <el-table
          v-loading="loading"
          :data="tableData"
          stripe
          style="width: 100%"
        >
          <el-table-column type="index" label="序号" width="80" align="center" />

          <el-table-column prop="name" label="姓名" width="120" />

          <el-table-column prop="gender" label="性别" width="80" align="center">
            <template #default="{ row }">
              <el-tag :type="row.gender === 'male' ? 'primary' : 'success'">
                {{ row.gender === 'male' ? '男' : '女' }}
              </el-tag>
            </template>
          </el-table-column>

          <el-table-column prop="idCard" label="身份证号码" width="180" />

          <el-table-column prop="phone" label="电话号码" width="140" />

          <el-table-column prop="birthDate" label="出生日期" width="120" />

          <el-table-column prop="nation" label="民族" width="100" />

          <el-table-column
            prop="totalOrderCount"
            label="挂单总次数"
            width="120"
            align="center"
          >
            <template #default="{ row }">
              <el-tag type="warning">{{ row.totalOrderCount }}</el-tag>
            </template>
          </el-table-column>

          <el-table-column label="操作" width="180" align="center" fixed="right">
            <template #default="{ row }">
              <el-button
                type="primary"
                size="small"
                @click="handleViewDetail(row)"
              >
                查看
              </el-button>
              <el-button
                type="info"
                size="small"
                @click="handleViewHistory(row)"
              >
                历史记录
              </el-button>
            </template>
          </el-table-column>
        </el-table>

        <!-- 分页 -->
        <div class="pagination-wrapper">
          <el-pagination
            v-model:current-page="pagination.currentPage"
            v-model:page-size="pagination.pageSize"
            :page-sizes="[5, 10, 20, 50]"
            :total="pagination.total"
            layout="total, sizes, prev, pager, next, jumper"
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
          />
        </div>
      </el-card>
    </div>

    <!-- 查看详情弹窗 -->
    <el-dialog
      v-model="detailVisible"
      title="查看详细信息"
      width="600px"
      :close-on-click-modal="false"
    >
      <div v-if="currentRecord" class="detail-content">
        <el-descriptions :column="2" border>
          <el-descriptions-item label="姓名">{{ currentRecord.name }}</el-descriptions-item>
          <el-descriptions-item label="性别">
            {{ currentRecord.gender === 'male' ? '男' : '女' }}
          </el-descriptions-item>
          <el-descriptions-item label="身份证号码" :span="2">
            {{ currentRecord.idCard }}
          </el-descriptions-item>
          <el-descriptions-item label="电话号码">{{ currentRecord.phone }}</el-descriptions-item>
          <el-descriptions-item label="出生日期">{{ currentRecord.birthDate }}</el-descriptions-item>
          <el-descriptions-item label="民族">{{ currentRecord.nation }}</el-descriptions-item>
          <el-descriptions-item label="挂单总次数">
            <el-tag type="warning">{{ currentRecord.totalOrderCount }}</el-tag>
          </el-descriptions-item>
          <el-descriptions-item label="地址" :span="2">
            {{ currentRecord.address || '暂无' }}
          </el-descriptions-item>
        </el-descriptions>
      </div>
    </el-dialog>

    <!-- 历史记录弹窗 -->
    <el-dialog
      v-model="historyVisible"
      title="历史挂单记录"
      width="800px"
      :close-on-click-modal="false"
    >
      <div v-if="currentRecord" class="history-content">
        <div class="history-header">
          <h3>{{ currentRecord.name }} 的挂单历史</h3>
          <p>共 {{ historyData.length }} 条记录</p>
        </div>

        <el-table :data="historyData" stripe style="width: 100%">
          <el-table-column type="index" label="序号" width="80" align="center" />
          <el-table-column prop="orderDate" label="挂单日期" width="120" />
          <el-table-column prop="orderType" label="挂单类型" width="120">
            <template #default="{ row }">
              <el-tag :type="getOrderTypeTag(row.orderType)">
                {{ getOrderTypeText(row.orderType) }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="amount" label="金额" width="120" align="right">
            <template #default="{ row }">
              ¥{{ row.amount?.toFixed(2) || '0.00' }}
            </template>
          </el-table-column>
          <el-table-column prop="status" label="状态" width="100" align="center">
            <template #default="{ row }">
              <el-tag :type="getStatusTag(row.status)">
                {{ getStatusText(row.status) }}
              </el-tag>
            </template>
          </el-table-column>
          <el-table-column prop="remark" label="备注" min-width="150" />
        </el-table>
      </div>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Search, Refresh, Download } from '@element-plus/icons-vue'

// 类型定义
interface PendingOrderRecord {
  id: string
  name: string
  gender: 'male' | 'female'
  idCard: string
  phone: string
  birthDate: string
  nation: string
  totalOrderCount: number
  address?: string
}

interface OrderHistory {
  id: string
  orderDate: string
  orderType: 'normal' | 'urgent' | 'special'
  amount: number
  status: 'pending' | 'completed' | 'cancelled'
  remark: string
}

interface FilterForm {
  name: string
  gender: string
  orderCount: number | null
}

// 响应式数据
const loading = ref(false)
const exporting = ref(false)
const detailVisible = ref(false)
const historyVisible = ref(false)
const currentRecord = ref<PendingOrderRecord | null>(null)
const historyData = ref<OrderHistory[]>([])

// 筛选表单
const filterForm = reactive<FilterForm>({
  name: '',
  gender: '',
  orderCount: null
})

// 分页数据
const pagination = reactive({
  currentPage: 1,
  pageSize: 5,
  total: 0
})

// 表格数据
const tableData = ref<PendingOrderRecord[]>([])

// 模拟数据
const mockData: PendingOrderRecord[] = [
  {
    id: '1',
    name: '张三',
    gender: 'male',
    idCard: '110101199001011234',
    phone: '13800138000',
    birthDate: '1990-01-01',
    nation: '汉族',
    totalOrderCount: 5,
    address: '北京市朝阳区'
  },
  {
    id: '2',
    name: '李四',
    gender: 'female',
    idCard: '110101199002021234',
    phone: '13800138001',
    birthDate: '1990-02-02',
    nation: '汉族',
    totalOrderCount: 3,
    address: '北京市海淀区'
  },
  {
    id: '3',
    name: '王五',
    gender: 'male',
    idCard: '110101199003031234',
    phone: '13800138002',
    birthDate: '1990-03-03',
    nation: '回族',
    totalOrderCount: 8,
    address: '北京市西城区'
  }
]

const mockHistoryData: OrderHistory[] = [
  {
    id: '1',
    orderDate: '2024-01-15',
    orderType: 'normal',
    amount: 1000.00,
    status: 'completed',
    remark: '正常挂单'
  },
  {
    id: '2',
    orderDate: '2024-01-20',
    orderType: 'urgent',
    amount: 2000.00,
    status: 'pending',
    remark: '紧急挂单'
  },
  {
    id: '3',
    orderDate: '2024-01-25',
    orderType: 'special',
    amount: 1500.00,
    status: 'completed',
    remark: '特殊挂单'
  }
]

// 方法
const loadData = async () => {
  loading.value = true
  try {
    // 模拟API调用
    await new Promise(resolve => setTimeout(resolve, 500))

    // 过滤数据
    let filteredData = [...mockData]

    if (filterForm.name) {
      filteredData = filteredData.filter(item =>
        item.name.includes(filterForm.name)
      )
    }

    if (filterForm.gender) {
      filteredData = filteredData.filter(item =>
        item.gender === filterForm.gender
      )
    }

    if (filterForm.orderCount !== null) {
      filteredData = filteredData.filter(item =>
        item.totalOrderCount >= filterForm.orderCount!
      )
    }

    pagination.total = filteredData.length

    // 分页
    const start = (pagination.currentPage - 1) * pagination.pageSize
    const end = start + pagination.pageSize
    tableData.value = filteredData.slice(start, end)

  } catch (error) {
    ElMessage.error('加载数据失败')
  } finally {
    loading.value = false
  }
}

const handleSearch = () => {
  pagination.currentPage = 1
  loadData()
}

const handleReset = () => {
  filterForm.name = ''
  filterForm.gender = ''
  filterForm.orderCount = null
  pagination.currentPage = 1
  loadData()
}

const handleExport = async () => {
  exporting.value = true
  try {
    // 模拟导出
    await new Promise(resolve => setTimeout(resolve, 1000))
    ElMessage.success('导出成功')
  } catch (error) {
    ElMessage.error('导出失败')
  } finally {
    exporting.value = false
  }
}

const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  loadData()
}

const handleCurrentChange = (page: number) => {
  pagination.currentPage = page
  loadData()
}

const handleViewDetail = (record: PendingOrderRecord) => {
  currentRecord.value = record
  detailVisible.value = true
}

const handleViewHistory = (record: PendingOrderRecord) => {
  currentRecord.value = record
  // 模拟加载历史数据
  historyData.value = [...mockHistoryData]
  historyVisible.value = true
}

// 辅助方法
const getOrderTypeTag = (type: string) => {
  const tagMap: Record<string, string> = {
    normal: 'primary',
    urgent: 'danger',
    special: 'warning'
  }
  return tagMap[type] || 'info'
}

const getOrderTypeText = (type: string) => {
  const textMap: Record<string, string> = {
    normal: '正常',
    urgent: '紧急',
    special: '特殊'
  }
  return textMap[type] || '未知'
}

const getStatusTag = (status: string) => {
  const tagMap: Record<string, string> = {
    pending: 'warning',
    completed: 'success',
    cancelled: 'info'
  }
  return tagMap[status] || 'info'
}

const getStatusText = (status: string) => {
  const textMap: Record<string, string> = {
    pending: '待处理',
    completed: '已完成',
    cancelled: '已取消'
  }
  return textMap[status] || '未知'
}

// 生命周期
onMounted(() => {
  loadData()
})
</script>

<style scoped lang="scss">
.pending-order-query {
  padding: 24px;
  background: #f5f5f5;
  min-height: 100vh;
}

.page-header {
  margin-bottom: 24px;

  h1 {
    font-size: 24px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
  }

  p {
    color: #6b7280;
    font-size: 14px;
  }
}

.filter-section {
  margin-bottom: 24px;

  .filter-form {
    .el-form-item {
      margin-bottom: 0;
    }
  }
}

.table-section {
  background: white;
  border-radius: 8px;

  .pagination-wrapper {
    margin-top: 20px;
    display: flex;
    justify-content: center;
  }
}

.detail-content {
  .el-descriptions {
    margin-top: 16px;
  }
}

.history-content {
  .history-header {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;

    h3 {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 8px;
    }

    p {
      color: #6b7280;
      font-size: 14px;
    }
  }
}

// 响应式设计
@media (max-width: 768px) {
  .pending-order-query {
    padding: 16px;
  }

  .filter-form {
    .el-form-item {
      display: block;
      margin-right: 0;
      margin-bottom: 16px;
    }
  }
}
</style>